{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "linuxAdminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "User name for the Linux virtual machines that are part of the Kubernetes cluster and DVM."
      }
    },
    "sshPublicKey": {
      "metadata": {
        "description": "SSH public key used for auth to all Linux machines created as part of the the Kubernetes cluster and DVM."
      },
      "type": "string"
    },
    "masterProfileDnsPrefix": {
      "type": "string",
      "metadata": {
        "description": "This must be a region-unique name e.g. k8s-12345. Try to chose it same as the resource group name as best practice."
      }
    },
    "agentPoolProfileCount": {
      "defaultValue": 3,
      "metadata": {
        "description": "Kubernetes linux node pool profile count"
      },
      "type": "int"
    },
    "agentPoolProfileVMSize": {
      "defaultValue": "Standard_D2_v2",
      "metadata": {
        "description": "The virtual machine size of the Kubernetes linux agent nodes"
      },
      "type": "string"
    },
    "masterPoolProfileCount": {
      "defaultValue": 3,
      "metadata": {
        "description": "Kubernetes master pool profile count"
      },
      "type": "int"
    },
    "masterPoolProfileVMSize": {
      "defaultValue": "Standard_D2_v2",
      "metadata": {
        "description": "The virtual machine size of the Kubernetes master nodes"
      },
      "type": "string"
    },
    "storageProfile": {
      "defaultValue": "manageddisk",
      "metadata": {
        "description": "The Storage Profile"
      },
      "type": "string"
    },
    "servicePrincipalClientId": {
      "metadata": {
        "description": "The Service Principal application ID (used by the Kubernetes Azure cloud provider). More help here: https://github.com/Azure/aks-engine/blob/master/docs/topics/service-principals.md"
      },
      "type": "securestring"
    },
    "servicePrincipalClientSecret": {
      "metadata": {
        "description": "The Service Principal Client Secret."
      },
      "type": "securestring"
    },
    "identitySystem": {
      "defaultValue": "AzureAD",
      "allowedValues": [
        "AzureAD",
        "ADFS"
      ],
      "metadata": {
        "description": "The identity system of Azure Stack. The value could be AzureAD or ADFS"
      },
      "type": "string"
    },
    "kubernetesAzureCloudProviderVersion": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "This is the version for the Kubernetes Azure cloud provider. We would use a custom Kubernetes build specifically for Azure Stack for each version."
      }
    },
    "kubernetesAzureCloudProviderRelease": {
      "type": "string",
      "defaultValue": "1.14",
      "metadata": {
        "description": "This is the release for the Kubernetes Azure cloud provider. We would use a custom Kubernetes build specifically for Azure Stack for each version."
      }
    },
    "aksEngineBaseURL": {
      "type": "string",
      "defaultValue": "https://github.com/Azure/aks-engine/releases/download",
      "metadata": {
        "description": "The beginning of the URL for downloading the AKS Engine binary"
      }
    },
    "aksEngineReleaseVersion": {
      "type": "string",
      "defaultValue": "v0.48.0",
      "metadata": {
        "description": "The version of AKS Engine to download"
      }
    },
    "galleryRepository": {
      "type": "string",
      "defaultValue": "msazurestackworkloads/azurestack-gallery",
      "metadata": {
        "description": "Marketplace item repository"
      }
    },
    "galleryBranch": {
      "type": "string",
      "defaultValue": "master",
      "metadata": {
        "description": "Marketplace item branch"
      }
    },
    "clusterDefinitionFileName": {
      "type": "string",
      "defaultValue": "clusterDefinition.json",
      "metadata": {
        "description": "The name of the file containing the cluster definition"
      }
    },
    "customVnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the custom vnet"
      }
    },
    "masterSubnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the master subnet"
      }
    },
    "agentSubnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the agent subnet"
      }
    },
    "firstConsecutiveStaticIP": {
      "type": "string",
      "defaultValue": "10.100.0.5",
      "metadata": {
        "description": "First Consective Static IP"
      }
    },
    "networkPlugin": {
      "defaultValue": "kubenet",
      "allowedValues": [
        "flannel",
        "azure",
        "kubenet"
      ],
      "metadata": {
        "description": "Network plugin which will deployed in Kubernetes cluster"
      },
      "type": "string"
    },
    "networkPolicy": {
      "defaultValue": "",
      "allowedValues": [
        "",
        "azure"
      ],
      "metadata": {
        "description": "Network policy which will deployed in Kubernetes cluster"
      },
      "type": "string"
    },
    "availabilityProfile": {
      "defaultValue": "AvailabilitySet",
      "allowedValues": [
        "AvailabilitySet",
        "VirtualMachineScaleSets"
      ],
      "metadata": {
        "description": "Availability profile that nodes in the Kubernetes cluster will be deployed with"
      },
      "type": "string"
    },
    "windowsAgentPoolProfileCount": {
      "defaultValue": "0",
      "metadata": {
        "description": "Kubernetes Windows node pool profile count"
      },
      "type": "string"
    },
    "windowsAgentPoolProfileVMSize": {
      "defaultValue": "Standard_D2_v2",
      "metadata": {
        "description": "The virtual machine size of the Kubernetes Windows agent nodes"
      },
      "type": "string"
    },
    "windowsAdminUsername": {
      "defaultValue": "azureuser",
      "metadata": {
        "description": "User name for the Windows virtual machines that are part of the Kubernetes cluster."
      },
      "type": "string"
    },
    "windowsAdminPassword": {
      "defaultValue": "",
      "metadata": {
        "description": "Password for the Windows virtual machines that are part of the Kubernetes cluster."
      },
      "type": "securestring"
    },
    "customWindowsPackageURL": {
      "defaultValue": "",
      "metadata": {
        "description": "Custom Windows K8s zip location which will be used to deploy(kubelet, kubeproxy) on Windows node."
      },
      "type": "string"
    },
    "nodeDistro": {
      "defaultValue": "aks-ubuntu-16.04",
      "allowedValues": [
        "ubuntu",
        "aks-ubuntu-16.04"
      ],
      "metadata": {
        "description": "Node distro to be used to deploy Kubernetes on Azure Stack."
      },
      "type": "string"
    },
    "enableTillerAddOn": {
      "type": "string",
      "defaultValue": "false",
      "metadata": {
        "description": "Flag to enable Tiller addon"
      }
    },
    "containerRuntime": {
      "type": "string",
      "defaultValue": "docker",
      "allowedValues": [
        "docker",
        "containerd"
      ],
      "metadata": {
        "description": "Container runtime to deploy on each cluster node."
      }
    },
    "localAKSeBinaryURL": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Stack blob url to download AKS engine from a blob store in disconnected environment "
      }
    },
    "dvmImagePublisher": {
      "type": "string",
      "defaultValue": "microsoft-aks",
      "metadata": {
        "description": "Azure VM image publisher to be used for the DVM"
      }
    },
    "dvmImageOffer": {
      "type": "string",
      "defaultValue": "aks",
      "metadata": {
        "description": "Azure VM image offer to be used for the DVM"
      }
    },
    "dvmImageSku": {
      "type": "string",
      "defaultValue": "aks-engine-ubuntu-1604-202003",
      "metadata": {
        "description": "Azure VM image sku to be used for the DVM"
      }
    },
    "dvmImageVersion": {
      "type": "string",
      "defaultValue": "2020.03.19",
      "metadata": {
        "description": "Azure VM image version to be used for the DVM"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[resourceGroup().name]",
    "dnsNameForPublicIP": "[toLower(concat('vmd-dns', parameters('masterProfileDnsPrefix')))]",
    "location": "[resourceGroup().location]",
    "vmSize": "Standard_D2_v2",
    "OSDiskName": "osdisk",
    "nicName": "[concat('vmd-vnic', uniqueString(resourceGroup().id))]",
    "addressPrefix": "10.0.0.0/24",
    "subnetName": "mySubnet",
    "subnetPrefix": "10.0.0.0/24",
    "storageAccountName": "[concat('vmdsa', uniquestring(resourceGroup().id))]",
    "storageAccountType": "Standard_LRS",
    "publicIPAddressName": "[concat('vmd-publicIP', uniqueString(resourceGroup().id))]",
    "publicIPAddressType": "Static",
    "vmStorageAccountContainerName": "vhds",
    "vmName": "[concat('vmd-', uniqueString(resourceGroup().id))]",
    "virtualNetworkName": "[concat('vmd-vnet-', uniqueString(resourceGroup().id))]",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]",
    "networkSecurityGroupName": "[tolower(concat('vmd-nsg',uniquestring(resourceGroup().id)))]",
    "sshKeyPath": "[concat('/home/',parameters('linuxAdminUsername'),'/.ssh/authorized_keys')]",
    "tenantSubscriptionId": "[subscription().subscriptionId]",
    "scriptName": "script",
    "singleQuote": "'",
    "scriptParameters": "[concat('IDENTITY_SYSTEM=','\"',parameters('identitySystem'),'\"',' ENABLE_TILLER=','\"',parameters('enableTillerAddOn'),'\"' ,' CONTAINER_RUNTIME=','\"',parameters('containerRuntime'),'\"' ,' WINDOWS_CUSTOM_PACKAGE=','\"',parameters('customWindowsPackageURL'),'\"' ,' WINDOWS_AGENT_COUNT=','\"',parameters('windowsAgentPoolProfileCount'),'\"' ,' WINDOWS_AGENT_SIZE=','\"',parameters('windowsAgentPoolProfileVMSize'),'\"',' WINDOWS_ADMIN_USERNAME=','\"',parameters('windowsAdminUsername'),'\"',' WINDOWS_ADMIN_PASSWORD=','\"',parameters('windowsAdminPassword'),'\"',' NETWORK_PLUGIN=','\"',parameters('networkPlugin'),'\"',' NETWORK_POLICY=','\"',parameters('networkPolicy'),'\"',' AVAILABILITY_PROFILE=','\"',parameters('availabilityProfile'),'\"',' FIRST_CONSECUTIVE_STATIC_IP=','\"',parameters('firstConsecutiveStaticIP'),'\"',' AGENT_SUBNET_NAME=','\"',parameters('agentSubnetName'),'\"',' MASTER_SUBNET_NAME=','\"',parameters('masterSubnetName'),'\"',' CUSTOM_VNET_NAME=','\"',parameters('customVnetName'),'\"',' NODE_DISTRO=','\"',parameters('nodeDistro'),'\"',' RESOURCE_GROUP_NAME=','\"',variables('resourceGroupName'),'\"',' PUBLICIP_DNS=','\"',variables('dnsNameForPublicIP'),'\"' ,' TENANT_ID=','\"',subscription().tenantId,'\"' ,' TENANT_SUBSCRIPTION_ID=','\"',variables('tenantSubscriptionId'),'\"',' ADMIN_USERNAME=','\"',parameters('linuxAdminUsername'),'\"',' MASTER_DNS_PREFIX=','\"',parameters('masterProfileDnsPrefix'),'\"' ,' AGENT_COUNT=','\"',parameters('agentPoolProfileCount'),'\"' ,' AGENT_SIZE=','\"',parameters('agentPoolProfileVMSize'),'\"' ,' MASTER_COUNT=','\"',parameters('masterPoolProfileCount'),'\"',' MASTER_SIZE=','\"',parameters('masterPoolProfileVMSize'),'\"' ,' SPN_CLIENT_ID=','\"',parameters('servicePrincipalClientId'),'\"' ,' SPN_CLIENT_SECRET=','\"',parameters('servicePrincipalClientSecret'),'\"' ,' K8S_AZURE_CLOUDPROVIDER_RELEASE=','\"',parameters('kubernetesAzureCloudProviderRelease'),'\"' ,' K8S_AZURE_CLOUDPROVIDER_VERSION=','\"',parameters('kubernetesAzureCloudProviderVersion'),'\"' ,' REGION_NAME=','\"',variables('location'),'\"' ,' SSH_PUBLICKEY=','\"',parameters('sshPublicKey'),'\"' ,' STORAGE_PROFILE=','\"',parameters('storageProfile'),'\"',' AKSE_BASE_URL=','\"',parameters('aksEngineBaseURL'), '\"', ' AKSE_RELEASE_VERSION=','\"',parameters('aksEngineReleaseVersion'),'\"',' GALLERY_REPO=','\"',parameters('galleryRepository'),'\"',' GALLERY_BRANCH=','\"',parameters('galleryBranch'),'\"',' DEFINITION_TEMPLATE_NAME=','\"',parameters('clusterDefinitionFileName'),'\"',' DISCONNECTED_AKS_ENGINE_URL=','\"',parameters('localAKSeBinaryURL'),'\"')]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[toLower(variables('storageAccountName'))]",
      "apiVersion": "2015-06-15",
      "location": "[variables('location')]",
      "properties": {
        "accountType": "[variables('storageAccountType')]"
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('networkSecurityGroupName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
            "name": "ssh",
            "properties": {
              "description": "Allow SSH",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 200,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[variables('location')]",
      "properties": {
        "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
        "dnsSettings": {
          "domainNameLabel": "[variables('dnsNameForPublicIP')]"
        }
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('virtualNetworkName')]",
      "location": "[variables('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('addressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "[variables('subnetPrefix')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]",
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
        "[variables('networkSecurityGroupName')]"
      ],
      "properties": {
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
        },
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2016-03-30",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
         "customData": "[base64(concat('#cloud-config\n\nwrite_files:\n- path: \"/opt/azure/containers/script.sh\"\n  permissions: \"0744\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    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'))]",
          "computerName": "[variables('vmName')]",
          "adminUsername": "[parameters('linuxAdminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": "true",
            "ssh": {
              "publicKeys": [
                {
                  "keyData": "[parameters('sshPublicKey')]",
                  "path": "[variables('sshKeyPath')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('dvmImagePublisher')]",
            "offer": "[parameters('dvmImageOffer')]",
            "sku": "[parameters('dvmImageSku')]",
            "version": "[parameters('dvmImageVersion')]"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob, variables('vmStorageAccountContainerName'),'/',variables('OSDiskName'),'.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": "true",
            "storageUri": "[reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/LinuxCustomScriptExtension')]",
      "apiVersion": "2016-03-30",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]",
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.0",
        "autoUpgradeMinorVersion": "true",
        "protectedSettings": {
          "commandToExecute": "[concat(variables('scriptParameters'), ' PUBLICIP_FQDN=', '\"', reference(resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName')),'2015-06-15').dnsSettings.fqdn,'\"',' /bin/bash /opt/azure/containers/script.sh >> /var/log/azure/deploy-script-dvm.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "dvmPublicIpFqdn": {
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName')),'2015-06-15').dnsSettings.fqdn]",
      "type": "string"
    }
  }
}
